void CheckConfluence() {
    // 1. تعیین محل وقوع جرم در گذشته
    int history_shift = settings.kijun_period; // معمولاً 26

    // 2. تعیین کندل شاهد ماجرا در زمان حال
    int current_shift = 1;

    // مطمئن میشیم دیتای کافی داریم
    if (iBars(symbol, PERIOD_CURRENT) < history_shift + 2) return;

    // 3. مقدار شاهد ماجرا (چیکواسپن) رو از کندل شماره ۱ می‌خونیم
    double chikou_value = iClose(symbol, PERIOD_CURRENT, current_shift);

    // 4. مقادیر دو مظنون اصلی (تنکان و کیجون) رو از 26 کندل قبل می‌خونیم
    double tenkan_history[], kijun_history[];
    ArraySetAsSeries(tenkan_history, true);
    ArraySetAsSeries(kijun_history, true);
    if (CopyBuffer(ichimoku_handle, 0, history_shift, 1, tenkan_history) <= 0 || CopyBuffer(ichimoku_handle, 1, history_shift, 1, kijun_history) <= 0) {
        Log("خطا در بازجویی از مظنونین در گذشته!");
        return;
    }

    // 5. بررسی تلاقی بین شاهد امروزی و مظنونین قدیمی
    double tolerance = settings.talaqi_tolerance_multiplier * SymbolInfoDouble(symbol, SYMBOL_POINT);
    double max_val = MathMax(chikou_value, MathMax(tenkan_history[0], kijun_history[0]));
    double min_val = MathMin(chikou_value, MathMin(tenkan_history[0], kijun_history[0]));

    if (max_val - min_val < tolerance) {
        // تلاقی پیدا شد! حالا باید جهت رو مشخص کنیم
        DrawConfluenceObject(history_shift); // علامت رو در محل جرم میذاریم

        // برای تعیین جهت، وضعیت تنکان و کیجون رو در گذشته بررسی می‌کنیم
        double tenkan_prev[], kijun_prev[];
        ArraySetAsSeries(tenkan_prev, true);
        ArraySetAsSeries(kijun_prev, true);
        if (CopyBuffer(ichimoku_handle, 0, history_shift + 1, 1, tenkan_prev) <= 0 || CopyBuffer(ichimoku_handle, 1, history_shift + 1, 1, kijun_prev) <= 0) {
            Log("خطا در بررسی سوابق مظنونین.");
            return;
        }

        // اگر در گذشته، تنکان بالای کیجون بوده و چیکو (قیمت الان) هم بالای اونهاست -> سیگنال خرید
        if (tenkan_history[0] > kijun_history[0] && chikou_value > tenkan_history[0]) {
            AddPotentialSignal(true);
            DrawFlagObject(history_shift, true);
        } 
        // اگر در گذشته، کیجون بالای تنکان بوده و چیکو (قیمت الان) هم پایین اونهاست -> سیگنال فروش
        else if (kijun_history[0] > tenkan_history[0] && chikou_value < tenkan_history[0]) {
            AddPotentialSignal(false);
            DrawFlagObject(history_shift, false);
        }
    }
}
