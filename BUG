SSignal CFamily::GetSignal() //
{
   SSignal signal = {"", ""};
   
   // سیگنال فقط وقتی صادر میشه که در حالت CHILD2_ACTIVE باشیم
   // و تازه وارد ناحیه طلایی شده باشیم.
   // و هنوز سیگنالی از این فاز صادر نکرده باشیم.
   if(m_state == CHILD2_ACTIVE && m_child2 != NULL) //
   {
      string temp_levels[]; //
      int count = StringSplit(InpGoldenZone, StringGetCharacter(",", 0), temp_levels); //
      if(count < 2) //
      {
         Log("خطا: ناحیه طلایی نامعتبر است: " + InpGoldenZone); //
         return signal; //
      }
      
      double level_1 = StringToDouble(temp_levels[0]) / 100.0; //
      double level_2 = StringToDouble(temp_levels[1]) / 100.0; //
      
      if(level_1 >= level_2) //
      {
         Log("خطا: ناحیه طلایی نامعتبر است، حداقل باید کوچکتر از حداکثر باشد: " + InpGoldenZone); //
         return signal; //
      }
      
      double price_level_1 = m_child2.GetPrice100() + (m_child2.GetPrice0() - m_child2.GetPrice100()) * level_1; //
      double price_level_2 = m_child2.GetPrice100() + (m_child2.GetPrice0() - m_child2.GetPrice100()) * level_2; //
      
      double zone_lower_bound = MathMin(price_level_1, price_level_2); //
      double zone_upper_bound = MathMax(price_level_1, price_level_2); //
      
      double current_price = SymbolInfoDouble(_Symbol, SYMBOL_BID); //
      
      bool in_golden_zone = (current_price >= zone_lower_bound && current_price <= zone_upper_bound); //
                               
      if(in_golden_zone) //
      {
         signal.type = m_direction == LONG ? "Buy" : "Sell"; //
         signal.id = m_id + "_" + TimeToString(TimeCurrent()) + "_" + (m_direction == LONG ? "Long" : "Short") + "_" + (m_child2.IsSuccessChild2() ? "Success" : "Failure"); //
         Log("سیگنال " + signal.type + " صادر شد: ID=" + signal.id + ", قیمت=" + DoubleToString(current_price, _Digits)); //
         
         // حالا که سیگنال رو صادر کردیم، وضعیت رو به COMPLETED تغییر میدیم.
         // این باعث میشه دفعه بعد دیگه این سیگنال صادر نشه.
         m_state = COMPLETED; // 👈 این خط الان اینجاست!
      }
   }
   
   return signal; //
}
